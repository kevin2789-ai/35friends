<script>
(() => {
  const API_URL = "https://script.google.com/macros/s/AKfycbxKk9nfIit0opSEmgcrBFIUWVxXgV60X7C5uQCEU3u41_UIkd5LhqkX-clEekcxRSub1w/exec";

  const REGION = {
    "서울특별시": ["강남구","강동구","강북구","강서구","관악구","광진구","구로구","금천구","노원구","도봉구","동대문구","동작구","마포구","서대문구","서초구","성동구","성북구","송파구","양천구","영등포구","용산구","은평구","종로구","중구","중랑구"],
    "부산광역시": ["강서구","금정구","기장군","남구","동구","동래구","부산진구","북구","사상구","사하구","서구","수영구","연제구","영도구","중구","해운대구"],
    "대구광역시": ["군위군","남구","달서구","달성군","동구","북구","서구","수성구","중구"],
    "인천광역시": ["강화군","계양구","남동구","동구","미추홀구","부평구","서구","연수구","옹진군","중구"],
    "광주광역시": ["광산구","남구","동구","북구","서구"],
    "대전광역시": ["대덕구","동구","서구","유성구","중구"],
    "울산광역시": ["남구","동구","북구","울주군","중구"],
    "세종특별자치시": ["세종시"],
    "경기도": ["수원시","성남시","고양시","용인시","부천시","안산시","안양시","남양주시","화성시","평택시","의정부시","시흥시","파주시","김포시","광명시","군포시","광주시","이천시","양주시","오산시","구리시","안성시","포천시","의왕시","하남시","여주시","동두천시","과천시","가평군","양평군","연천군"],
    "강원특별자치도": ["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
    "충청북도": ["청주시","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
    "충청남도": ["천안시","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
    "전북특별자치도": ["전주시","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
    "전라남도": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
    "경상북도": ["포항시","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
    "경상남도": ["창원시","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
    "제주특별자치도": ["제주시","서귀포시"]
  };

  const JOB_TYPES = ["회사원","자영업","교직원","사업","군인","공무원","기타"];
  const YEARS = Array.from({length: 8}, (_,i)=> 1965+i);
  const MONTHS = Array.from({length:12}, (_,i)=> i+1);
  const CLASSES = [1,2,3,4,5,6];

  const $ = (id) => document.getElementById(id);

  const form = $("form");
  const status = $("status");
  const countText = $("countText");
  const searchEl = $("search");
  const tbody = $("tbody");

  const nameEl = $("name");
  const phoneEl = $("phone");
  const sidoEl = $("sido");
  const sigunguEl = $("sigungu");

  const g1El = $("g1"), g2El = $("g2"), g3El = $("g3");

  const jobTypeEl = $("jobType");
  const jobTextEl = $("jobText");
  const jobTextWrap = $("jobTextWrap");

  const birthYearEl = $("birthYear");
  const birthMonthEl = $("birthMonth");
  const birthDayEl = $("birthDay");
  const birthCalEl = $("birthCal");
  const birthHint = $("birthHint");

  const fee2026El = $("fee2026");

  const saveBtn = $("saveBtn");
  const resetBtn = $("resetBtn");
  const reloadBtn = $("reloadBtn");

  let records = [];
  let editingId = null;

  let sortKey = "createdAt";
  let sortDir = "desc";

  initSelects();
  loadList();

  phoneEl.addEventListener("input", () => {
    const cursor = phoneEl.selectionStart || 0;
    const before = phoneEl.value;
    const formatted = formatPhoneKR(before);
    phoneEl.value = formatted;
    const diff = formatted.length - before.length;
    const nextPos = Math.max(0, cursor + diff);
    try { phoneEl.setSelectionRange(nextPos, nextPos); } catch(e) {}
  });

  sidoEl.addEventListener("change", () => fillSigungu(sidoEl.value));
  jobTypeEl.addEventListener("change", onJobTypeChange);
  birthYearEl.addEventListener("change", syncDays);
  birthMonthEl.addEventListener("change", syncDays);

  resetBtn.addEventListener("click", () => resetForm());
  reloadBtn.addEventListener("click", () => loadList(true));
  searchEl.addEventListener("input", () => render());

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const item = readForm();
    if (!item) return;

    setBusy(true);
    try {
      if (editingId) {
        await apiPost({ action:"update", id: editingId, ...item });
        toast("수정 저장 완료");
      } else {
        await apiPost({ action:"add", ...item });
        toast("저장 완료");
      }
      resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  });

  function formatPhoneKR(raw) {
    const digits = String(raw || "").replace(/\D/g, "");
    if (digits.startsWith("02")) {
      if (digits.length <= 2) return digits;
      if (digits.length <= 5) return `${digits.slice(0,2)}-${digits.slice(2)}`;
      if (digits.length <= 9) return `${digits.slice(0,2)}-${digits.slice(2, digits.length-4)}-${digits.slice(-4)}`;
      return `${digits.slice(0,2)}-${digits.slice(2, digits.length-4)}-${digits.slice(-4)}`;
    }
    if (digits.length <= 3) return digits;
    if (digits.length <= 7) return `${digits.slice(0,3)}-${digits.slice(3)}`;
    if (digits.length === 10) return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
    if (digits.length >= 11) return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7,11)}`;
    return digits;
  }

  function initSelects() {
    sidoEl.innerHTML = "";
    Object.keys(REGION).forEach((s, idx) => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      if (idx === 0) opt.selected = true;
      sidoEl.appendChild(opt);
    });
    fillSigungu(sidoEl.value);

    [g1El,g2El,g3El].forEach(sel => {
      sel.innerHTML = "";
      CLASSES.forEach(n => {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = `${n}반`;
        sel.appendChild(opt);
      });
      sel.value = "1";
    });

    jobTypeEl.innerHTML = "";
    JOB_TYPES.forEach((t, idx) => {
      const opt = document.createElement("option");
      opt.value = t; opt.textContent = t;
      if (idx === 0) opt.selected = true;
      jobTypeEl.appendChild(opt);
    });
    onJobTypeChange();

    birthYearEl.innerHTML = "";
    YEARS.forEach((y, idx) => {
      const opt = document.createElement("option");
      opt.value = String(y); opt.textContent = `${y}년`;
      if (idx === 0) opt.selected = true;
      birthYearEl.appendChild(opt);
    });

    birthMonthEl.innerHTML = "";
    MONTHS.forEach((m, idx) => {
      const opt = document.createElement("option");
      opt.value = String(m); opt.textContent = `${m}월`;
      if (idx === 0) opt.selected = true;
      birthMonthEl.appendChild(opt);
    });

    syncDays();
  }

  function fillSigungu(sido) {
    const list = REGION[sido] || [];
    sigunguEl.innerHTML = "";
    list.forEach((g, idx) => {
      const opt = document.createElement("option");
      opt.value = g; opt.textContent = g;
      if (idx === 0) opt.selected = true;
      sigunguEl.appendChild(opt);
    });
  }

  function onJobTypeChange() {
    const isOther = jobTypeEl.value === "기타";
    jobTextWrap.style.display = isOther ? "block" : "none";
    if (!isOther) jobTextEl.value = "";
  }

  function daysInMonth(y, m) {
    return new Date(Number(y), Number(m), 0).getDate();
  }

  function syncDays() {
    const y = birthYearEl.value;
    const m = birthMonthEl.value;
    const maxDay = daysInMonth(y, m);

    const prev = birthDayEl.value || "1";
    birthDayEl.innerHTML = "";
    for (let d=1; d<=maxDay; d++) {
      const opt = document.createElement("option");
      opt.value = String(d);
      opt.textContent = `${d}일`;
      birthDayEl.appendChild(opt);
    }
    birthDayEl.value = (Number(prev) <= maxDay) ? prev : "1";
    birthHint.textContent = `${y}년 ${m}월은 1~${maxDay}일 선택 가능`;
  }

  function readForm() {
    const name = nameEl.value.trim();
    const phone = formatPhoneKR(phoneEl.value.trim());
    const sido = sidoEl.value;
    const sigungu = sigunguEl.value;

    const g1 = g1El.value || "1";
    const g2 = g2El.value || "1";
    const g3 = g3El.value || "1";

    const jobType = jobTypeEl.value;
    const jobText = jobTextEl.value.trim();

    const birthYear = birthYearEl.value;
    const birthMonth = birthMonthEl.value;
    const birthDay = birthDayEl.value;
    const birthCal = birthCalEl.value;

    const fee2026 = fee2026El.value || "NO";

    if (!name) return toast("이름을 입력하세요.");
    if (!phone) return toast("연락처를 입력하세요.");
    if (!sido || !sigungu) return toast("주소를 선택하세요.");
    if (!jobType) return toast("하는 일을 선택하세요.");
    if (jobType === "기타" && !jobText) return toast("기타 내용을 입력하세요.");

    return {
      name, phone, sido, sigungu,
      g1, g2, g3,
      jobType, jobText,
      birthYear, birthMonth, birthDay, birthCal,
      fee2026
    };
  }

  function resetForm() {
    editingId = null;
    saveBtn.textContent = "저장";
    form.reset();

    sidoEl.selectedIndex = 0;
    fillSigungu(sidoEl.value);

    g1El.value = "1"; g2El.value = "1"; g3El.value = "1";
    jobTypeEl.selectedIndex = 0;
    onJobTypeChange();

    birthCalEl.value = "양력";
    birthYearEl.selectedIndex = 0;
    birthMonthEl.selectedIndex = 0;
    syncDays();

    fee2026El.value = "NO";

    status.textContent = "";
    nameEl.focus();
  }

  function sortValue(r, key){
    if(key === "createdAt") return String(r.createdAt || "");
    if(key === "addr") return `${r.sido||""} ${r.sigungu||""}`.trim().toLowerCase();

    if(key === "job"){
      const j = (r.jobType === "기타") ? (r.jobText || "") : (r.jobType || "");
      return String(j).toLowerCase();
    }

    if(key === "birth"){
      const y = String(r.birthYear||"").padStart(4,"0");
      const m = String(r.birthMonth||"").padStart(2,"0");
      const d = String(r.birthDay||"").padStart(2,"0");
      return `${y}-${m}-${d}-${r.birthCal||""}`;
    }

    if(key === "fee2026") return String(r.fee2026 || "");

    return String(r[key] ?? "").toLowerCase();
  }

  function render() {
    const q = searchEl.value.trim().toLowerCase();

    let filtered = records.filter(r => {
      if (!q) return true;
      const birth = `${r.birthYear||""}.${r.birthMonth||""}.${r.birthDay||""} ${r.birthCal||""}`;
      const job = (r.jobType === "기타") ? `기타 ${r.jobText||""}` : (r.jobType||"");
      const addr = `${r.sido||""} ${r.sigungu||""}`.trim();
      const fee = `${r.fee2026||""}`;
      const blob = `${r.name||""} ${String(r.phone ?? "")} ${addr} ${job} ${birth} ${fee}`.toLowerCase();
      return blob.includes(q);
    });

    filtered.sort((a,b)=>{
      const va = sortValue(a, sortKey);
      const vb = sortValue(b, sortKey);
      if(va < vb) return sortDir === "asc" ? -1 : 1;
      if(va > vb) return sortDir === "asc" ? 1 : -1;
      return 0;
    });

    countText.textContent = `(${filtered.length}건 / 전체 ${records.length}건)`;
    tbody.innerHTML = "";

    filtered.forEach(r => {
      const tr = document.createElement("tr");

      const addr = `${escapeHtml(r.sido||"")} ${escapeHtml(r.sigungu||"")}`.trim();
      const job = r.jobType === "기타"
        ? (r.jobText ? `기타: ${escapeHtml(r.jobText)}` : "기타")
        : escapeHtml(r.jobType||"");

      const birth = (r.birthYear || r.birthMonth || r.birthDay || r.birthCal)
        ? `${escapeHtml(r.birthYear||"")}.${escapeHtml(r.birthMonth||"")}.${escapeHtml(r.birthDay||"")} (${escapeHtml(r.birthCal||"")})`
        : "-";

      const created = r.createdAt ? new Date(r.createdAt).toLocaleString() : "";
      const fee = (String(r.fee2026 ?? "").trim().toUpperCase() === "YES") ? "YES" : "NO";

      tr.innerHTML = `
        <td class="muted">${escapeHtml(created)}</td>
        <td><strong>${escapeHtml(r.name||"")}</strong></td>
        <td>${escapeHtml(String(r.phone ?? ""))}</td>
        <td>${addr || '<span class="muted">-</span>'}</td>
        <td>${job || '<span class="muted">-</span>'}</td>
        <td>${birth}</td>
        <td><span class="pill">${fee}</span></td>
        <td>
          <span class="pill">1학년 ${escapeHtml(r.g1||"1")}반</span><br/>
          <span class="pill">2학년 ${escapeHtml(r.g2||"1")}반</span><br/>
          <span class="pill">3학년 ${escapeHtml(r.g3||"1")}반</span>
        </td>
        <td>
          <div class="btns">
            <button class="secondary" data-act="edit" data-id="${escapeAttr(r.id)}">수정</button>
            <button class="danger" data-act="del" data-id="${escapeAttr(r.id)}">삭제</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        if (act === "edit") startEdit(id);
        if (act === "del") await delOne(id);
      });
    });

    document.querySelectorAll("th .sort").forEach(btn => {
      btn.onclick = () => {
        const key = btn.dataset.sort;

        if (sortKey === key) {
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortKey = key;
          sortDir = (key === "createdAt") ? "desc" : "asc";
        }

        document.querySelectorAll("th .sort").forEach(b => {
          b.classList.remove("asc","desc");
          if (b.dataset.sort === sortKey) b.classList.add(sortDir);
        });

        render();
      };
    });

    document.querySelectorAll("th .sort").forEach(b => {
      b.classList.remove("asc","desc");
      if (b.dataset.sort === sortKey) b.classList.add(sortDir);
    });
  }

  function startEdit(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!r) return;

    editingId = String(id);
    saveBtn.textContent = "수정 저장";

    nameEl.value = r.name || "";
    phoneEl.value = String(r.phone ?? "");

    if (r.sido) {
      sidoEl.value = r.sido;
      fillSigungu(r.sido);
      sigunguEl.value = r.sigungu || sigunguEl.value;
    }

    g1El.value = String(r.g1 || "1");
    g2El.value = String(r.g2 || "1");
    g3El.value = String(r.g3 || "1");

    jobTypeEl.value = r.jobType || "회사원";
    onJobTypeChange();
    jobTextEl.value = r.jobText || "";

    birthCalEl.value = r.birthCal || "양력";
    birthYearEl.value = String(r.birthYear || YEARS[0]);
    birthMonthEl.value = String(r.birthMonth || MONTHS[0]);
    syncDays();
    birthDayEl.value = String(r.birthDay || "1");

    fee2026El.value = (String(r.fee2026 ?? "").trim().toUpperCase() === "YES") ? "YES" : "NO";

    toast(`수정 중: ${r.name || ""}`);
    window.scrollTo({ top: 0, behavior: "smooth" });
    nameEl.focus();
  }

  async function delOne(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!confirm(`${r?.name || ""} 항목을 삭제할까요?`)) return;

    setBusy(true);
    try {
      await apiPost({ action:"delete", id: String(id) });
      toast("삭제 완료");
      if (editingId === String(id)) resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function loadList(forceToast=false) {
    setBusy(true);
    try {
      const url = `${API_URL}?action=list&ts=${Date.now()}`;
      const res = await fetch(url, { method:"GET" });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "list failed");

      records = Array.isArray(json.rows) ? json.rows : [];
      render();
      if (forceToast) toast("목록 새로고침 완료");
    } catch (err) {
      toast("목록 불러오기 실패: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function apiPost(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "request failed");
    return json;
  }

  function setBusy(b) {
    saveBtn.disabled = b;
    resetBtn.disabled = b;
    reloadBtn.disabled = b;
  }

  function toast(msg) {
    status.textContent = msg;
    setTimeout(() => { if (status.textContent === msg) status.textContent = ""; }, 3500);
    return null;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s).replaceAll('"', "&quot;"); }
})();
</script>
