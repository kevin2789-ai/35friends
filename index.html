<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>광운35회 친구들 모임</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width:1100px; margin:0 auto; padding:16px; }
    h1 { margin:8px 0 12px; font-size:20px; font-weight:900; }
    .card { background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:14px; }
    .grid { display:grid; gap:12px; grid-template-columns:repeat(12, 1fr); }
    .col-12{grid-column:span 12;}
    .col-6{grid-column:span 6;}
    .col-4{grid-column:span 4;}
    .col-3{grid-column:span 3;}
    label{display:block; font-size:12px; color:#555; margin-bottom:6px;}
    input, select, button{
      width:100%; box-sizing:border-box;
      padding:11px 11px; border-radius:12px;
      border:1px solid #d8dbe6; background:#fff; font-size:14px;
    }
    input:focus, select:focus{ outline:2px solid rgba(99,102,241,.25); border-color:#6366f1; }
    button{ cursor:pointer; border:none; background:#6366f1; color:#fff; font-weight:900; }
    button.secondary{ background:#eef0ff; color:#2c2f7a; border:1px solid #d8dbff; }
    button.danger{ background:#ef4444; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .muted{ color:#666; font-size:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #eef0f6; padding:10px 6px; text-align:left; font-size:13px; vertical-align:top;}
    th{ font-size:12px; color:#555; white-space:nowrap; }
    .pill{ display:inline-block; padding:4px 8px; background:#f1f5ff; border:1px solid #dfe6ff; border-radius:999px; font-size:12px; color:#2c2f7a; }
    .btns{ display:flex; gap:6px; flex-wrap:wrap; }
    .btns button{ padding:7px 10px; font-size:12px; border-radius:10px; width:auto; }
    .notice{ padding:10px 12px; border-radius:12px; background:#fffbe6; border:1px solid #ffe58f; color:#614700; font-size:12px; }

    /* 정렬 버튼 */
    th .sort{
      background:transparent;
      border:none;
      padding:0;
      font:inherit;
      font-weight:900;
      color:#2c2f7a;
      cursor:pointer;
      width:auto;
    }
    th .sort:after{
      content:"";
      display:inline-block;
      width:12px;
      margin-left:6px;
      opacity:.65;
    }
    th .sort.asc:after{ content:"▲"; }
    th .sort.desc:after{ content:"▼"; }

    @media (max-width:760px){
      .col-6,.col-4,.col-3{grid-column:span 12;}
      .actions{justify-content:stretch;}
      .btns button{ flex:1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>광운35회 친구들 모임</h1>

    <div class="card" style="margin-bottom:14px;">
      <form id="form">
        <div class="grid">
          <div class="col-6">
            <label>이름</label>
            <input id="name" required placeholder="예: 홍길동" />
          </div>

          <div class="col-6">
            <label>연락처</label>
            <input id="phone" required placeholder="숫자만 입력 (예: 01012345678)" inputmode="numeric" />
            <div class="muted">※ 숫자만 입력하면 자동으로 '-'가 들어갑니다.</div>
          </div>

          <div class="col-6">
            <label>주소 - 시/도</label>
            <select id="sido" required></select>
          </div>
          <div class="col-6">
            <label>주소 - 구/군/시</label>
            <select id="sigungu" required></select>
          </div>

          <div class="col-4">
            <label>1학년 (1~6반)</label>
            <select id="g1" required></select>
          </div>
          <div class="col-4">
            <label>2학년 (1~6반)</label>
            <select id="g2" required></select>
          </div>
          <div class="col-4">
            <label>3학년 (1~6반)</label>
            <select id="g3" required></select>
          </div>

          <div class="col-6">
            <label>하는 일</label>
            <select id="jobType" required></select>
          </div>
          <div class="col-6" id="jobTextWrap" style="display:none;">
            <label>기타(직접 입력)</label>
            <input id="jobText" placeholder="예: 프리랜서, 은퇴, 주부 등" />
          </div>

          <div class="col-4">
            <label>생일 - 연도(1965~1972)</label>
            <select id="birthYear" required></select>
          </div>
          <div class="col-4">
            <label>생일 - 월</label>
            <select id="birthMonth" required></select>
          </div>
          <div class="col-4">
            <label>생일 - 일</label>
            <select id="birthDay" required></select>
          </div>

          <div class="col-6">
            <label>음력/양력</label>
            <select id="birthCal" required>
              <option value="양력" selected>양력</option>
              <option value="음력">음력</option>
            </select>
          </div>

          <!-- ✅ 추가: 2026 회비납부 -->
          <div class="col-6">
            <label>2026년 회비납부</label>
            <select id="fee2026" required>
              <option value="NO" selected>NO</option>
              <option value="YES">YES</option>
            </select>
            <div class="muted">※ YES/NO만 선택 가능합니다.</div>
          </div>

          <div class="col-12">
            <div class="muted" id="birthHint"></div>
          </div>

          <div class="col-12 actions">
            <button type="submit" id="saveBtn">저장</button>
            <button type="button" class="secondary" id="resetBtn">입력 초기화</button>
            <button type="button" class="secondary" id="reloadBtn">목록 새로고침</button>
          </div>

          <div class="col-12">
            <div class="muted" id="status"></div>
          </div>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:10px;">
        <div>
          <strong>저장된 목록</strong>
          <span class="muted" id="countText"></span>
        </div>
        <div style="min-width:260px;">
          <input id="search" placeholder="이름/연락처/주소/하는일/생일/회비 검색" />
        </div>
      </div>

      <div class="notice" style="margin-bottom:10px;">
        기본 정렬은 <b>최신(▼)</b> 입니다. 헤더를 누르면 오름/내림 정렬됩니다.
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th><button type="button" class="sort" data-sort="createdAt">최신</button></th>
              <th><button type="button" class="sort" data-sort="name">이름</button></th>
              <th><button type="button" class="sort" data-sort="phone">연락처</button></th>
              <th><button type="button" class="sort" data-sort="addr">주소</button></th>
              <th><button type="button" class="sort" data-sort="job">하는 일</button></th>
              <th><button type="button" class="sort" data-sort="birth">생일</button></th>
              <!-- ✅ 추가: 회비 정렬 -->
              <th><button type="button" class="sort" data-sort="fee2026">회비(2026)</button></th>
              <th style="min-width:130px;">학년/반</th>
              <th style="min-width:160px;">관리</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  // ✅ 본인 Apps Script Web App (/exec) 주소로 맞추세요
  const API_URL = "https://script.google.com/macros/s/AKfycbwoQgFscJc5mtAhSakeNL9x2MG0HPXIFGKHbreZYsVNLHsXeEJ5Rmqj1iWC20PdfxLsGw/exec";

  const REGION = {
    "서울특별시": ["강남구","강동구","강북구","강서구","관악구","광진구","구로구","금천구","노원구","도봉구","동대문구","동작구","마포구","서대문구","서초구","성동구","성북구","송파구","양천구","영등포구","용산구","은평구","종로구","중구","중랑구"],
    "부산광역시": ["강서구","금정구","기장군","남구","동구","동래구","부산진구","북구","사상구","사하구","서구","수영구","연제구","영도구","중구","해운대구"],
    "대구광역시": ["군위군","남구","달서구","달성군","동구","북구","서구","수성구","중구"],
    "인천광역시": ["강화군","계양구","남동구","동구","미추홀구","부평구","서구","연수구","옹진군","중구"],
    "광주광역시": ["광산구","남구","동구","북구","서구"],
    "대전광역시": ["대덕구","동구","서구","유성구","중구"],
    "울산광역시": ["남구","동구","북구","울주군","중구"],
    "세종특별자치시": ["세종시"],
    "경기도": ["수원시","성남시","고양시","용인시","부천시","안산시","안양시","남양주시","화성시","평택시","의정부시","시흥시","파주시","김포시","광명시","군포시","광주시","이천시","양주시","오산시","구리시","안성시","포천시","의왕시","하남시","여주시","동두천시","과천시","가평군","양평군","연천군"],
    "강원특별자치도": ["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
    "충청북도": ["청주시","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
    "충청남도": ["천안시","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
    "전북특별자치도": ["전주시","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
    "전라남도": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
    "경상북도": ["포항시","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
    "경상남도": ["창원시","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
    "제주특별자치도": ["제주시","서귀포시"]
  };

  const JOB_TYPES = ["회사원","자영업","교직원","사업","군인","공무원","기타"];
  const YEARS = Array.from({length: 8}, (_,i)=> 1965+i);
  const MONTHS = Array.from({length:12}, (_,i)=> i+1);
  const CLASSES = [1,2,3,4,5,6];

  const $ = (id) => document.getElementById(id);

  const form = $("form");
  const status = $("status");
  const countText = $("countText");
  const searchEl = $("search");
  const tbody = $("tbody");

  const nameEl = $("name");
  const phoneEl = $("phone");
  const sidoEl = $("sido");
  const sigunguEl = $("sigungu");

  const g1El = $("g1"), g2El = $("g2"), g3El = $("g3");

  const jobTypeEl = $("jobType");
  const jobTextEl = $("jobText");
  const jobTextWrap = $("jobTextWrap");

  const birthYearEl = $("birthYear");
  const birthMonthEl = $("birthMonth");
  const birthDayEl = $("birthDay");
  const birthCalEl = $("birthCal");
  const birthHint = $("birthHint");

  // ✅ 추가: 회비
  const fee2026El = $("fee2026");

  const saveBtn = $("saveBtn");
  const resetBtn = $("resetBtn");
  const reloadBtn = $("reloadBtn");

  let records = [];
  let editingId = null;

  // 기본 정렬: 최신 저장순
  let sortKey = "createdAt";
  let sortDir = "desc";

  initSelects();
  loadList();

  phoneEl.addEventListener("input", () => {
    const cursor = phoneEl.selectionStart || 0;
    const before = phoneEl.value;
    const formatted = formatPhoneKR(before);
    phoneEl.value = formatted;
    const diff = formatted.length - before.length;
    const nextPos = Math.max(0, cursor + diff);
    try { phoneEl.setSelectionRange(nextPos, nextPos); } catch(e) {}
  });

  sidoEl.addEventListener("change", () => fillSigungu(sidoEl.value));
  jobTypeEl.addEventListener("change", onJobTypeChange);
  birthYearEl.addEventListener("change", syncDays);
  birthMonthEl.addEventListener("change", syncDays);

  resetBtn.addEventListener("click", () => resetForm());
  reloadBtn.addEventListener("click", () => loadList(true));
  searchEl.addEventListener("input", () => render());

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const item = readForm();
    if (!item) return;

    setBusy(true);
    try {
      if (editingId) {
        await apiPost({ action:"update", id: editingId, ...item });
        toast("수정 저장 완료");
      } else {
        await apiPost({ action:"add", ...item });
        toast("저장 완료");
      }
      resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  });

  function formatPhoneKR(raw) {
    const digits = String(raw || "").replace(/\D/g, "");
    if (digits.startsWith("02")) {
      if (digits.length <= 2) return digits;
      if (digits.length <= 5) return `${digits.slice(0,2)}-${digits.slice(2)}`;
      if (digits.length <= 9) return `${digits.slice(0,2)}-${digits.slice(2, digits.length-4)}-${digits.slice(-4)}`;
      return `${digits.slice(0,2)}-${digits.slice(2, digits.length-4)}-${digits.slice(-4)}`;
    }
    if (digits.length <= 3) return digits;
    if (digits.length <= 7) return `${digits.slice(0,3)}-${digits.slice(3)}`;
    if (digits.length === 10) return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
    if (digits.length >= 11) return `${digits.slice(0,3)}-${digits.slice(3,7)}-${digits.slice(7,11)}`;
    return digits;
  }

  function initSelects() {
    // 시/도
    sidoEl.innerHTML = "";
    Object.keys(REGION).forEach((s, idx) => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      if (idx === 0) opt.selected = true;
      sidoEl.appendChild(opt);
    });
    fillSigungu(sidoEl.value);

    // 반
    [g1El,g2El,g3El].forEach(sel => {
      sel.innerHTML = "";
      CLASSES.forEach(n => {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = `${n}반`;
        sel.appendChild(opt);
      });
      sel.value = "1";
    });

    // 하는 일
    jobTypeEl.innerHTML = "";
    JOB_TYPES.forEach((t, idx) => {
      const opt = document.createElement("option");
      opt.value = t; opt.textContent = t;
      if (idx === 0) opt.selected = true;
      jobTypeEl.appendChild(opt);
    });
    onJobTypeChange();

    // 생일 연/월
    birthYearEl.innerHTML = "";
    YEARS.forEach((y, idx) => {
      const opt = document.createElement("option");
      opt.value = String(y); opt.textContent = `${y}년`;
      if (idx === 0) opt.selected = true;
      birthYearEl.appendChild(opt);
    });

    birthMonthEl.innerHTML = "";
    MONTHS.forEach((m, idx) => {
      const opt = document.createElement("option");
      opt.value = String(m); opt.textContent = `${m}월`;
      if (idx === 0) opt.selected = true;
      birthMonthEl.appendChild(opt);
    });

    syncDays();
  }

  function fillSigungu(sido) {
    const list = REGION[sido] || [];
    sigunguEl.innerHTML = "";
    list.forEach((g, idx) => {
      const opt = document.createElement("option");
      opt.value = g; opt.textContent = g;
      if (idx === 0) opt.selected = true;
      sigunguEl.appendChild(opt);
    });
  }

  function onJobTypeChange() {
    const isOther = jobTypeEl.value === "기타";
    jobTextWrap.style.display = isOther ? "block" : "none";
    if (!isOther) jobTextEl.value = "";
  }

  function daysInMonth(y, m) {
    return new Date(Number(y), Number(m), 0).getDate();
  }

  function syncDays() {
    const y = birthYearEl.value;
    const m = birthMonthEl.value;
    const maxDay = daysInMonth(y, m);

    const prev = birthDayEl.value || "1";
    birthDayEl.innerHTML = "";
    for (let d=1; d<=maxDay; d++) {
      const opt = document.createElement("option");
      opt.value = String(d);
      opt.textContent = `${d}일`;
      birthDayEl.appendChild(opt);
    }
    birthDayEl.value = (Number(prev) <= maxDay) ? prev : "1";
    birthHint.textContent = `${y}년 ${m}월은 1~${maxDay}일 선택 가능`;
  }

  function readForm() {
    const name = nameEl.value.trim();
    const phone = formatPhoneKR(phoneEl.value.trim());
    const sido = sidoEl.value;
    const sigungu = sigunguEl.value;

    const g1 = g1El.value || "1";
    const g2 = g2El.value || "1";
    const g3 = g3El.value || "1";

    const jobType = jobTypeEl.value;
    const jobText = jobTextEl.value.trim();

    const birthYear = birthYearEl.value;
    const birthMonth = birthMonthEl.value;
    const birthDay = birthDayEl.value;
    const birthCal = birthCalEl.value;

    const fee2026 = fee2026El.value || "NO";

    if (!name) return toast("이름을 입력하세요.");
    if (!phone) return toast("연락처를 입력하세요.");
    if (!sido || !sigungu) return toast("주소를 선택하세요.");
    if (!jobType) return toast("하는 일을 선택하세요.");
    if (jobType === "기타" && !jobText) return toast("기타 내용을 입력하세요.");

    return {
      name, phone, sido, sigungu,
      g1, g2, g3,
      jobType, jobText,
      birthYear, birthMonth, birthDay, birthCal,
      fee2026
    };
  }

  function resetForm() {
    editingId = null;
    saveBtn.textContent = "저장";
    form.reset();

    sidoEl.selectedIndex = 0;
    fillSigungu(sidoEl.value);

    g1El.value = "1"; g2El.value = "1"; g3El.value = "1";
    jobTypeEl.selectedIndex = 0;
    onJobTypeChange();

    birthCalEl.value = "양력";
    birthYearEl.selectedIndex = 0;
    birthMonthEl.selectedIndex = 0;
    syncDays();

    fee2026El.value = "NO";

    status.textContent = "";
    nameEl.focus();
  }

  function sortValue(r, key){
    if(key === "createdAt") return String(r.createdAt || "");
    if(key === "addr") return `${r.sido||""} ${r.sigungu||""}`.trim().toLowerCase();

    if(key === "job"){
      const j = (r.jobType === "기타") ? (r.jobText || "") : (r.jobType || "");
      return String(j).toLowerCase();
    }

    if(key === "birth"){
      const y = String(r.birthYear||"").padStart(4,"0");
      const m = String(r.birthMonth||"").padStart(2,"0");
      const d = String(r.birthDay||"").padStart(2,"0");
      return `${y}-${m}-${d}-${r.birthCal||""}`;
    }

    if(key === "fee2026") return String(r.fee2026 || "");

    return String(r[key] ?? "").toLowerCase();
  }

  function render() {
    const q = searchEl.value.trim().toLowerCase();

    let filtered = records.filter(r => {
      if (!q) return true;
      const birth = `${r.birthYear||""}.${r.birthMonth||""}.${r.birthDay||""} ${r.birthCal||""}`;
      const job = (r.jobType === "기타") ? `기타 ${r.jobText||""}` : (r.jobType||"");
      const addr = `${r.sido||""} ${r.sigungu||""}`.trim();
      const fee = `${r.fee2026||""}`;
      const blob = `${r.name||""} ${r.phone||""} ${addr} ${job} ${birth} ${fee}`.toLowerCase();
      return blob.includes(q);
    });

    filtered.sort((a,b)=>{
      const va = sortValue(a, sortKey);
      const vb = sortValue(b, sortKey);
      if(va < vb) return sortDir === "asc" ? -1 : 1;
      if(va > vb) return sortDir === "asc" ? 1 : -1;
      return 0;
    });

    countText.textContent = `(${filtered.length}건 / 전체 ${records.length}건)`;
    tbody.innerHTML = "";

    filtered.forEach(r => {
      const tr = document.createElement("tr");

      const addr = `${escapeHtml(r.sido||"")} ${escapeHtml(r.sigungu||"")}`.trim();
      const job = r.jobType === "기타"
        ? (r.jobText ? `기타: ${escapeHtml(r.jobText)}` : "기타")
        : escapeHtml(r.jobType||"");

      const birth = (r.birthYear || r.birthMonth || r.birthDay || r.birthCal)
        ? `${escapeHtml(r.birthYear||"")}.${escapeHtml(r.birthMonth||"")}.${escapeHtml(r.birthDay||"")} (${escapeHtml(r.birthCal||"")})`
        : "-";

      const created = r.createdAt ? new Date(r.createdAt).toLocaleString() : "";
      const fee = escapeHtml(r.fee2026 || "NO");

      tr.innerHTML = `
        <td class="muted">${escapeHtml(created)}</td>
        <td><strong>${escapeHtml(r.name||"")}</strong></td>
        <td>${escapeHtml(r.phone||"")}</td>
        <td>${addr || '<span class="muted">-</span>'}</td>
        <td>${job || '<span class="muted">-</span>'}</td>
        <td>${birth}</td>
        <td><span class="pill">${fee}</span></td>
        <td>
          <span class="pill">1학년 ${escapeHtml(r.g1||"1")}반</span><br/>
          <span class="pill">2학년 ${escapeHtml(r.g2||"1")}반</span><br/>
          <span class="pill">3학년 ${escapeHtml(r.g3||"1")}반</span>
        </td>
        <td>
          <div class="btns">
            <button class="secondary" data-act="edit" data-id="${escapeAttr(r.id)}">수정</button>
            <button class="danger" data-act="del" data-id="${escapeAttr(r.id)}">삭제</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        if (act === "edit") startEdit(id);
        if (act === "del") await delOne(id);
      });
    });

    document.querySelectorAll("th .sort").forEach(btn => {
      btn.onclick = () => {
        const key = btn.dataset.sort;

        if (sortKey === key) {
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortKey = key;
          sortDir = (key === "createdAt") ? "desc" : "asc";
        }

        document.querySelectorAll("th .sort").forEach(b => {
          b.classList.remove("asc","desc");
          if (b.dataset.sort === sortKey) b.classList.add(sortDir);
        });

        render();
      };
    });

    document.querySelectorAll("th .sort").forEach(b => {
      b.classList.remove("asc","desc");
      if (b.dataset.sort === sortKey) b.classList.add(sortDir);
    });
  }

  function startEdit(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!r) return;

    editingId = String(id);
    saveBtn.textContent = "수정 저장";

    nameEl.value = r.name || "";
    phoneEl.value = r.phone || "";

    if (r.sido) {
      sidoEl.value = r.sido;
      fillSigungu(r.sido);
      sigunguEl.value = r.sigungu || sigunguEl.value;
    }

    g1El.value = String(r.g1 || "1");
    g2El.value = String(r.g2 || "1");
    g3El.value = String(r.g3 || "1");

    jobTypeEl.value = r.jobType || "회사원";
    onJobTypeChange();
    jobTextEl.value = r.jobText || "";

    birthCalEl.value = r.birthCal || "양력";
    birthYearEl.value = String(r.birthYear || YEARS[0]);
    birthMonthEl.value = String(r.birthMonth || MONTHS[0]);
    syncDays();
    birthDayEl.value = String(r.birthDay || "1");

    fee2026El.value = r.fee2026 || "NO";

    toast(`수정 중: ${r.name || ""}`);
    window.scrollTo({ top: 0, behavior: "smooth" });
    nameEl.focus();
  }

  async function delOne(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!confirm(`${r?.name || ""} 항목을 삭제할까요?`)) return;

    setBusy(true);
    try {
      await apiPost({ action:"delete", id: String(id) });
      toast("삭제 완료");
      if (editingId === String(id)) resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function loadList(forceToast=false) {
    setBusy(true);
    try {
      const url = `${API_URL}?action=list&ts=${Date.now()}`;
      const res = await fetch(url, { method:"GET" });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "list failed");

      records = Array.isArray(json.rows) ? json.rows : [];
      render();
      if (forceToast) toast("목록 새로고침 완료");
    } catch (err) {
      toast("목록 불러오기 실패: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function apiPost(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "request failed");
    return json;
  }

  function setBusy(b) {
    saveBtn.disabled = b;
    resetBtn.disabled = b;
    reloadBtn.disabled = b;
  }

  function toast(msg) {
    status.textContent = msg;
    setTimeout(() => { if (status.textContent === msg) status.textContent = ""; }, 3500);
    return null;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s).replaceAll('"', "&quot;"); }
})();
</script>
</body>
</html>
