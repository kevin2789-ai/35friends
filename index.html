<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>35friends</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; }
    body { margin: 0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { margin: 8px 0 14px; font-size: 20px; }
    .card { background:#fff; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding: 14px; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    label { display:block; font-size: 12px; color:#555; margin-bottom:6px; }
    input, select, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid #d8dbe6;
      background: #fff;
      font-size: 14px;
    }
    input:focus, select:focus { outline: 2px solid rgba(99,102,241,.25); border-color:#6366f1; }
    .actions { display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    button { cursor:pointer; border:none; background:#6366f1; color:#fff; font-weight:700; }
    button.secondary { background:#eef0ff; color:#2c2f7a; border:1px solid #d8dbff; }
    button.danger { background:#ef4444; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#666; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eef0f6; padding: 10px 6px; text-align:left; font-size: 13px; vertical-align: top; }
    th { font-size:12px; color:#555; }
    .pill { display:inline-block; padding:4px 8px; background:#f1f5ff; border:1px solid #dfe6ff; border-radius: 999px; font-size:12px; color:#2c2f7a; }
    .small-btns { display:flex; gap:6px; }
    .small-btns button { padding: 7px 10px; font-size: 12px; border-radius: 10px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    @media (max-width: 760px) {
      .col-6, .col-4 { grid-column: span 12; }
      .actions { justify-content: stretch; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>35friends</h1>

    <div class="card" style="margin-bottom:14px;">
      <form id="form">
        <div class="grid">
          <div class="col-6">
            <label>이름</label>
            <input id="name" required placeholder="예: 홍길동" />
          </div>
          <div class="col-6">
            <label>연락처</label>
            <input id="phone" required placeholder="예: 010-1234-5678" inputmode="tel" />
          </div>

          <div class="col-6">
            <label>주소 - 시/도</label>
            <select id="sido" required></select>
          </div>
          <div class="col-6">
            <label>주소 - 구/군/시</label>
            <select id="sigungu" required></select>
          </div>

          <div class="col-12">
            <label>하는 일</label>
            <input id="job" placeholder="예: 학생, 회사원, 자영업 등" />
          </div>

          <div class="col-4">
            <label>1학년 (1~6반)</label>
            <select id="g1" required></select>
          </div>
          <div class="col-4">
            <label>2학년 (1~6반)</label>
            <select id="g2" required></select>
          </div>
          <div class="col-4">
            <label>3학년 (1~6반)</label>
            <select id="g3" required></select>
          </div>

          <div class="col-12 actions">
            <button type="submit" id="saveBtn">저장</button>
            <button type="button" class="secondary" id="resetBtn">입력 초기화</button>
            <button type="button" class="secondary" id="reloadBtn">목록 새로고침</button>
          </div>
          <div class="col-12 muted" id="status"></div>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div>
          <strong>저장된 목록</strong>
          <span class="muted" id="countText"></span>
        </div>
        <div style="min-width:240px;">
          <input id="search" placeholder="이름/연락처/주소/하는일 검색" />
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:80px;">이름</th>
              <th style="min-width:120px;">연락처</th>
              <th style="min-width:160px;">주소</th>
              <th style="min-width:120px;">하는 일</th>
              <th style="min-width:130px;">학년/반</th>
              <th style="min-width:140px;">관리</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  // ✅ 여기에 이미 넣어둠
  const API_URL = "https://script.google.com/macros/s/AKfycbwoQgFscJc5mtAhSakeNL9x2MG0HPXIFGKHbreZYsVNLHsXeEJ5Rmqj1iWC20PdfxLsGw/exec";

  // ---- 시/도 -> 구/군/시 데이터(필요하면 확장 가능) ----
  const REGION = {
    "서울특별시": ["강남구","강동구","강북구","강서구","관악구","광진구","구로구","금천구","노원구","도봉구","동대문구","동작구","마포구","서대문구","서초구","성동구","성북구","송파구","양천구","영등포구","용산구","은평구","종로구","중구","중랑구"],
    "부산광역시": ["강서구","금정구","기장군","남구","동구","동래구","부산진구","북구","사상구","사하구","서구","수영구","연제구","영도구","중구","해운대구"],
    "대구광역시": ["군위군","남구","달서구","달성군","동구","북구","서구","수성구","중구"],
    "인천광역시": ["강화군","계양구","남동구","동구","미추홀구","부평구","서구","연수구","옹진군","중구"],
    "광주광역시": ["광산구","남구","동구","북구","서구"],
    "대전광역시": ["대덕구","동구","서구","유성구","중구"],
    "울산광역시": ["남구","동구","북구","울주군","중구"],
    "세종특별자치시": ["세종시"],
    "경기도": ["수원시","성남시","고양시","용인시","부천시","안산시","안양시","남양주시","화성시","평택시","의정부시","시흥시","파주시","김포시","광명시","군포시","광주시","이천시","양주시","오산시","구리시","안성시","포천시","의왕시","하남시","여주시","동두천시","과천시","가평군","양평군","연천군"],
    "강원특별자치도": ["춘천시","원주시","강릉시","동해시","태백시","속초시","삼척시","홍천군","횡성군","영월군","평창군","정선군","철원군","화천군","양구군","인제군","고성군","양양군"],
    "충청북도": ["청주시","충주시","제천시","보은군","옥천군","영동군","증평군","진천군","괴산군","음성군","단양군"],
    "충청남도": ["천안시","공주시","보령시","아산시","서산시","논산시","계룡시","당진시","금산군","부여군","서천군","청양군","홍성군","예산군","태안군"],
    "전북특별자치도": ["전주시","군산시","익산시","정읍시","남원시","김제시","완주군","진안군","무주군","장수군","임실군","순창군","고창군","부안군"],
    "전라남도": ["목포시","여수시","순천시","나주시","광양시","담양군","곡성군","구례군","고흥군","보성군","화순군","장흥군","강진군","해남군","영암군","무안군","함평군","영광군","장성군","완도군","진도군","신안군"],
    "경상북도": ["포항시","경주시","김천시","안동시","구미시","영주시","영천시","상주시","문경시","경산시","의성군","청송군","영양군","영덕군","청도군","고령군","성주군","칠곡군","예천군","봉화군","울진군","울릉군"],
    "경상남도": ["창원시","진주시","통영시","사천시","김해시","밀양시","거제시","양산시","의령군","함안군","창녕군","고성군","남해군","하동군","산청군","함양군","거창군","합천군"],
    "제주특별자치도": ["제주시","서귀포시"]
  };
  const CLASSES = [1,2,3,4,5,6];

  // ---- DOM ----
  const $ = (id) => document.getElementById(id);
  const form = $("form");
  const nameEl = $("name");
  const phoneEl = $("phone");
  const jobEl = $("job");
  const sidoEl = $("sido");
  const sigunguEl = $("sigungu");
  const g1El = $("g1"), g2El = $("g2"), g3El = $("g3");
  const tbody = $("tbody");
  const status = $("status");
  const countText = $("countText");
  const searchEl = $("search");

  const saveBtn = $("saveBtn");
  const resetBtn = $("resetBtn");
  const reloadBtn = $("reloadBtn");

  let records = [];
  let editingId = null;

  // ---- init ----
  initSelects();
  loadList();

  // ---- events ----
  sidoEl.addEventListener("change", () => fillSigungu(sidoEl.value));
  resetBtn.addEventListener("click", () => resetForm());
  reloadBtn.addEventListener("click", () => loadList(true));
  searchEl.addEventListener("input", () => render());

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const item = readForm();
    if (!item) return;

    setBusy(true);
    try {
      if (editingId) {
        await apiPost({ action: "update", id: editingId, ...item });
        toast("수정 저장 완료");
      } else {
        await apiPost({ action: "add", ...item });
        toast("저장 완료");
      }
      resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  });

  // ---- helpers ----
  function initSelects() {
    // 시/도
    sidoEl.innerHTML = "";
    Object.keys(REGION).forEach((s, idx) => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      if (idx === 0) opt.selected = true;
      sidoEl.appendChild(opt);
    });
    fillSigungu(sidoEl.value);

    // 반 선택(1~6)
    [g1El,g2El,g3El].forEach(sel => {
      sel.innerHTML = "";
      CLASSES.forEach(n => {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = `${n}반`;
        sel.appendChild(opt);
      });
      sel.value = "1";
    });
  }

  function fillSigungu(sido) {
    const list = REGION[sido] || [];
    sigunguEl.innerHTML = "";
    list.forEach((g, idx) => {
      const opt = document.createElement("option");
      opt.value = g; opt.textContent = g;
      if (idx === 0) opt.selected = true;
      sigunguEl.appendChild(opt);
    });
  }

  function readForm() {
    const name = nameEl.value.trim();
    const phone = phoneEl.value.trim();
    const sido = sidoEl.value;
    const sigungu = sigunguEl.value;
    const job = jobEl.value.trim();
    const g1 = g1El.value;
    const g2 = g2El.value;
    const g3 = g3El.value;

    if (!name) return toast("이름을 입력하세요.");
    if (!phone) return toast("연락처를 입력하세요.");
    if (!sido || !sigungu) return toast("주소(시/도, 구/군/시)를 선택하세요.");

    // Apps Script가 기대하는 키들
    return { name, phone, sido, sigungu, job, g1, g2, g3 };
  }

  function resetForm() {
    editingId = null;
    saveBtn.textContent = "저장";
    form.reset();

    sidoEl.selectedIndex = 0;
    fillSigungu(sidoEl.value);
    g1El.value = "1"; g2El.value = "1"; g3El.value = "1";

    status.textContent = "";
    nameEl.focus();
  }

  function render() {
    const q = searchEl.value.trim().toLowerCase();
    const filtered = records.filter(r => {
      if (!q) return true;
      const blob = `${r.name||""} ${r.phone||""} ${r.sido||""} ${r.sigungu||""} ${r.job||""} ${r.g1||""} ${r.g2||""} ${r.g3||""}`.toLowerCase();
      return blob.includes(q);
    });

    countText.textContent = `(${filtered.length}건 / 전체 ${records.length}건)`;

    tbody.innerHTML = "";
    filtered.forEach(r => {
      const tr = document.createElement("tr");
      const addr = `${escapeHtml(r.sido||"")} ${escapeHtml(r.sigungu||"")}`.trim();

      tr.innerHTML = `
        <td><strong>${escapeHtml(r.name||"")}</strong></td>
        <td>${escapeHtml(r.phone||"")}</td>
        <td>${addr || '<span class="muted">-</span>'}</td>
        <td>${r.job ? escapeHtml(r.job) : '<span class="muted">-</span>'}</td>
        <td>
          <span class="pill">1학년 ${escapeHtml(r.g1||"")}반</span><br/>
          <span class="pill">2학년 ${escapeHtml(r.g2||"")}반</span><br/>
          <span class="pill">3학년 ${escapeHtml(r.g3||"")}반</span>
        </td>
        <td>
          <div class="small-btns">
            <button class="secondary" data-act="edit" data-id="${escapeAttr(r.id)}">수정</button>
            <button class="danger" data-act="del" data-id="${escapeAttr(r.id)}">삭제</button>
          </div>
          <div class="muted" style="margin-top:6px;">${r.createdAt ? escapeHtml(new Date(r.createdAt).toLocaleString()) : ""}</div>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        if (act === "edit") startEdit(id);
        if (act === "del") await delOne(id);
      });
    });
  }

  function startEdit(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!r) return;

    editingId = String(id);
    saveBtn.textContent = "수정 저장";

    nameEl.value = r.name || "";
    phoneEl.value = r.phone || "";
    jobEl.value = r.job || "";

    if (r.sido) {
      sidoEl.value = r.sido;
      fillSigungu(r.sido);
      sigunguEl.value = r.sigungu || sigunguEl.value;
    }

    g1El.value = String(r.g1 || "1");
    g2El.value = String(r.g2 || "1");
    g3El.value = String(r.g3 || "1");

    status.textContent = `수정 중: ${r.name || ""} (${r.phone || ""})`;
    window.scrollTo({ top: 0, behavior: "smooth" });
    nameEl.focus();
  }

  async function delOne(id) {
    const r = records.find(x => String(x.id) === String(id));
    if (!confirm(`${r?.name || ""} 항목을 삭제할까요?`)) return;

    setBusy(true);
    try {
      await apiPost({ action: "delete", id: String(id) });
      toast("삭제 완료");
      if (editingId === String(id)) resetForm();
      await loadList();
    } catch (err) {
      toast("오류: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function loadList(forceToast=false) {
    setBusy(true);
    try {
      const url = `${API_URL}?action=list&ts=${Date.now()}`; // 캐시 방지
      const res = await fetch(url, { method: "GET" });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "list failed");

      // rows: [{id, createdAt, name, phone, sido, sigungu, job, g1, g2, g3}, ...]
      records = Array.isArray(json.rows) ? json.rows : [];
      render();
      if (forceToast) toast("목록 새로고침 완료");
    } catch (err) {
      toast("목록 불러오기 실패: " + String(err));
    } finally {
      setBusy(false);
    }
  }

  async function apiPost(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error || "request failed");
    return json;
  }

  function setBusy(b) {
    saveBtn.disabled = b;
    resetBtn.disabled = b;
    reloadBtn.disabled = b;
  }

  function toast(msg) {
    status.textContent = msg;
    setTimeout(() => { if (status.textContent === msg) status.textContent = ""; }, 3000);
    return null;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s).replaceAll('"', "&quot;"); }
})();
</script>
</body>
</html>
